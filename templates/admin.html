{% extends "base.html" %}
{% block title %}{{ 'Admin Panel' if current_user_role == 'admin' else 'Seller Panel' }} - Amazoff{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="display-5"><i class="fas fa-cog me-2"></i>{{ 'Admin Panel' if current_user_role == 'admin' else 'Seller Panel' }}</h1>
                <p class="text-muted">Create new product listings{% if current_user_role == 'admin' %} and manage users{% endif %}</p>
            </div>
            <div>
                <a href="{{ url_for('seller_transactions') }}" class="btn btn-outline-primary">
                    <i class="fas fa-chart-line me-2"></i>Transaction History
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Create Product Form -->
    <div class="col-lg-7">
        <div class="card shadow-sm">
            <div class="card-header bg-cookie-dark text-white">
                <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Create New Product</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required maxlength="200">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Price ($) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="price" name="price" 
                                       step="0.01" min="0.01" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="">Select a category...</option>
                                <option value="electronics">Electronics</option>
                                <option value="clothing">Clothing</option>
                                <option value="home-garden">Home & Garden</option>
                                <option value="books">Books</option>
                                <option value="gaming">Gaming</option>
                                <option value="sports">Sports & Outdoors</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="4" 
                                  placeholder="Enter product description..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image" class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="image" name="image" 
                               accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
                        <small class="form-text text-muted">
                            Allowed formats: PNG, JPG, JPEG, GIF, WEBP (Max 16MB)
                        </small>
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 300px; max-height: 300px;">
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Analytics Panel -->
    <div class="col-lg-5">
        <div class="card shadow-sm">
            <div class="card-header bg-cookie-dark text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analytics</h5>
            </div>
            <div class="card-body">
                {% if current_user_role == 'admin' %}
                <!-- Admin Analytics -->
                <!-- User Count -->
                <div class="mb-4 pb-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-users fa-2x text-primary me-3"></i>
                        <div>
                            <h3 class="mb-0">{{ user_count }}</h3>
                            <small class="text-muted">Total Users</small>
                        </div>
                    </div>
                </div>
                
                <!-- Cart Analytics -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-shopping-cart me-2"></i>Items in Shopping Carts</h6>
                    {% if cart_analytics and cart_analytics|length > 0 %}
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Product</th>
                                    <th class="text-end">Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cart_analytics %}
                                <tr>
                                    <td>
                                        <small>{{ item.name }}</small>
                                    </td>
                                    <td class="text-end">
                                        <strong>{{ item.total_quantity }}</strong>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-shopping-cart fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0 small">No items in shopping carts yet.</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- All Products List (Admin Only) -->
                <div class="mb-4 pb-3 border-bottom">
                    <h6 class="mb-3"><i class="fas fa-box me-2"></i>All Products</h6>
                    {% if all_products and all_products|length > 0 %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th class="text-end">Views</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in all_products %}
                                <tr>
                                    <td><small><strong>{{ product.id }}</strong></small></td>
                                    <td>
                                        <small>{{ product.name }}</small>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-outline-info btn-sm" title="View Product">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-outline-primary btn-sm" title="Edit Product">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td class="text-end"><small>{{ product.view_count|default(0) }}</small></td>
                                    <td>
                                        {% if product.delisted %}
                                        <span class="badge bg-warning">Delisted</span>
                                        {% else %}
                                        <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if product.delisted %}
                                        <button class="btn btn-sm btn-outline-success" onclick="relistProduct({{ product.id }}, '{{ product.name|e }}')" title="Relist Product">
                                            <i class="fas fa-undo me-1"></i>Relist
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="delistProduct({{ product.id }}, '{{ product.name|e }}')" title="Delist Product">
                                            <i class="fas fa-eye-slash me-1"></i>Delist
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0 small">No products yet.</p>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <!-- Seller Analytics -->
                {% if seller_analytics %}
                <div class="mb-4 pb-3 border-bottom">
                    <h6 class="mb-3"><i class="fas fa-chart-line me-2"></i>Your Sales Summary</h6>
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body p-2 text-center">
                                    <h5 class="mb-0">{{ seller_analytics.total_views }}</h5>
                                    <small class="text-muted">Total Views</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body p-2 text-center">
                                    <h5 class="mb-0">{{ seller_analytics.total_in_cart }}</h5>
                                    <small class="text-muted">In Carts</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-light">
                                <div class="card-body p-2 text-center">
                                    <h5 class="mb-0">${{ "%.2f"|format(seller_analytics.total_sales) }}</h5>
                                    <small class="text-muted">Total Revenue</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Per-Product Analytics -->
                <div class="mb-4">
                    <h6 class="mb-3"><i class="fas fa-box me-2"></i>Product Analytics</h6>
                    {% if seller_analytics.products and seller_analytics.products|length > 0 %}
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Product</th>
                                    <th class="text-end">Views</th>
                                    <th class="text-end">In Cart</th>
                                    <th class="text-end">Sales</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in seller_analytics.products %}
                                <tr>
                                    <td>
                                        <small>{{ product.name }}</small>
                                        <div class="btn-group btn-group-sm mt-1">
                                            <a href="{{ url_for('product_detail', product_id=product.id) }}" class="btn btn-outline-primary btn-sm" title="View Product">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_product', product_id=product.id) }}" class="btn btn-outline-secondary btn-sm" title="Edit Product">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td class="text-end"><small>{{ product.views }}</small></td>
                                    <td class="text-end"><small>{{ product.in_cart }}</small></td>
                                    <td class="text-end"><small>${{ "%.2f"|format(product.sales) }}</small></td>
                                    <td>
                                        {% if product.delisted %}
                                        <span class="badge bg-warning mb-1 d-block">Delisted</span>
                                        <button class="btn btn-sm btn-outline-success" onclick="relistProduct({{ product.id }}, '{{ product.name|e }}')" title="Relist Product">
                                            <i class="fas fa-undo me-1"></i>Relist
                                        </button>
                                        {% else %}
                                        <span class="badge bg-success mb-1 d-block">Active</span>
                                        <button class="btn btn-sm btn-outline-danger" onclick="delistProduct({{ product.id }}, '{{ product.name|e }}')" title="Delist Product">
                                            <i class="fas fa-eye-slash me-1"></i>Delist
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0 small">No products yet.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}
                
                <!-- User Management (Admin Only) -->
                {% if current_user_role == 'admin' %}
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-users me-2"></i>User Management</h6>
                    </div>
                    <!-- Search Box -->
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" id="userSearch" 
                               placeholder="Search users..." onkeyup="filterUsers()">
                    </div>
                    {% if all_users and all_users|length > 0 %}
                    <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                        <table class="table table-sm table-hover" id="userTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in all_users %}
                                <tr class="user-row" data-username="{{ user.username|lower }}">
                                    <td><small>{{ user.username }}</small></td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'primary' if user.role == 'seller' else 'secondary' }}">
                                            {% if user.role == 'admin' %}
                                            <i class="fas fa-user-shield me-1"></i>Admin
                                            {% elif user.role == 'seller' %}
                                            <i class="fas fa-user-tag me-1"></i>Seller
                                            {% else %}
                                            <i class="fas fa-user me-1"></i>Buyer
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if user.banned %}
                                        <span class="badge bg-danger">Banned</span>
                                        {% else %}
                                        <span class="badge bg-success">Active</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.banned %}
                                        <!-- Banned users: Only show unlock button -->
                                        <button class="btn btn-sm btn-outline-success" onclick="toggleBan('{{ user.username }}', 'unban')" title="Unban User">
                                            <i class="fas fa-unlock me-1"></i>Unban
                                        </button>
                                        {% else %}
                                        <!-- Active users: Show role change and ban buttons -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            {% if user.role == 'buyer' %}
                                            <button class="btn btn-outline-primary" onclick="updateRole('{{ user.username }}', 'seller')" title="Make Seller">
                                                <i class="fas fa-user-tag"></i>
                                            </button>
                                            {% elif user.role == 'seller' %}
                                            <button class="btn btn-outline-secondary" onclick="updateRole('{{ user.username }}', 'buyer')" title="Make Buyer">
                                                <i class="fas fa-user"></i>
                                            </button>
                                            {% else %}
                                            <span class="btn btn-outline-secondary disabled" title="Admin">
                                                <i class="fas fa-user-shield"></i>
                                            </span>
                                            {% endif %}
                                            <button class="btn btn-outline-danger" onclick="toggleBan('{{ user.username }}', 'ban')" title="Ban User">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div id="noUsersMessage" class="text-center py-3 d-none">
                        <p class="text-muted mb-0 small">No users found matching your search.</p>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0 small">No users found.</p>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Image preview functionality
document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('previewImg').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById('imagePreview').style.display = 'none';
    }
});

// Role update functionality
function updateRole(username, newRole) {
    if (!confirm(`Change ${username} to ${newRole}?`)) {
        return;
    }
    
    fetch('/admin/update_role', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: username,
            role: newRole
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload
            alert(`Successfully changed ${username} to ${newRole}!`);
            location.reload();
        } else {
            alert('Failed to update role: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating role');
    });
}

// Delist product functionality
function delistProduct(productId, productName) {
    if (!confirm(`Are you sure you want to delist "${productName}" (ID: ${productId})? The product will be hidden from public view but can be relisted later.`)) {
        return;
    }
    
    fetch('/admin/delist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully delisted "${productName}"!`);
            location.reload();
        } else {
            alert('Failed to delist product: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error delisting product');
    });
}

// Relist product functionality
function relistProduct(productId, productName) {
    if (!confirm(`Are you sure you want to relist "${productName}" (ID: ${productId})? The product will be visible to the public again.`)) {
        return;
    }
    
    fetch('/admin/relist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully relisted "${productName}"!`);
            location.reload();
        } else {
            alert('Failed to relist product: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error relisting product');
    });
}

// Ban/unban functionality
function toggleBan(username, action) {
    const actionText = action === 'ban' ? 'ban' : 'unban';
    if (!confirm(`Are you sure you want to ${actionText} ${username}?`)) {
        return;
    }
    
    fetch('/admin/ban_user', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: username,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully ${action === 'ban' ? 'banned' : 'unbanned'} ${username}!`);
            location.reload();
        } else {
            alert('Failed to ' + actionText + ' user: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error ' + actionText + 'ing user');
    });
}

// User search/filter functionality
function filterUsers() {
    const searchInput = document.getElementById('userSearch');
    const filter = searchInput.value.toLowerCase();
    const rows = document.querySelectorAll('.user-row');
    const noUsersMessage = document.getElementById('noUsersMessage');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const username = row.getAttribute('data-username');
        if (username.includes(filter)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Show/hide "no users" message
    if (visibleCount === 0 && filter.length > 0) {
        noUsersMessage.classList.remove('d-none');
    } else {
        noUsersMessage.classList.add('d-none');
    }
}
</script>
{% endblock %}

